# 手动触发按钮功能更新说明

## 功能概述

手动触发按钮现在支持**按下状态下的连续监控**模式，用户可以通过点击按钮进入监听状态，然后使用快捷键D来触发截图匹配。

## 新增功能特性

### 1. 按钮状态切换
- **初始状态**: 显示"手动触发"，蓝色背景
- **激活状态**: 显示"停止触发"，红色背景
- **状态指示**: 右侧显示"🟢 监听中 (按D键触发)"标签

### 2. 连续监控模式
- 点击"手动触发"按钮进入监听模式
- 在监听模式下，按D键自动触发截图匹配
- 每次D键输入都会执行一次完整的匹配流程
- 再次点击按钮可停止监听模式

### 3. 增强的日志记录
- 详细的匹配过程日志
- OCR识别结果记录
- 数据库操作状态反馈
- 错误详情追踪

### 4. 自动数据记录
- 每次匹配结果自动存入数据库
- 支持OCR Level识别
- 实时更新Level计数表格
- 自动更新统计图表

## 使用方法

### 基本操作流程

1. **启动监控**
   - 点击"开始监控"按钮
   - 等待系统初始化完成

2. **激活手动触发模式**
   - 点击"手动触发"按钮
   - 按钮变为红色，显示"停止触发"
   - 状态标签显示"🟢 监听中 (按D键触发)"

3. **使用快捷键触发**
   - 按D键触发一次截图匹配
   - 系统自动执行模板匹配
   - 结果自动记录到数据库
   - 日志显示详细匹配信息

4. **停止监听模式**
   - 再次点击"手动触发"按钮
   - 按钮恢复蓝色，显示"手动触发"
   - 状态标签清空

### 快捷键说明

- **D键**: 触发截图和模板匹配
- **Ctrl+F1**: 退出程序（在连续监控模式下）

## 技术实现

### 核心组件

1. **状态管理**
   ```python
   self.manual_trigger_active = False  # 监听状态标志
   self.manual_trigger_thread = None   # 监听线程
   self.manual_trigger_event = threading.Event()  # 停止信号
   ```

2. **键盘监听器**
   - 使用 `pynput` 库实现全局键盘监听
   - 独立的监听线程，不影响主GUI响应
   - 支持优雅的停止和清理

3. **匹配流程**
   - 截图 → OCR识别 → 模板匹配 → 数据库记录
   - 完整的错误处理和日志记录
   - 实时UI更新和图表刷新

### 线程安全

- 使用 `threading.Event` 进行线程间通信
- 主线程和监听线程分离，避免阻塞
- 优雅的资源清理和状态同步

## 依赖要求

- `pynput`: 键盘监听功能
- `opencv-python`: 图像处理
- `Pillow`: 图像操作
- `sqlite3`: 数据库操作

## 安装依赖

```bash
pip install pynput opencv-python Pillow
```

## 注意事项

1. **权限要求**: 在某些系统上，键盘监听可能需要管理员权限
2. **性能考虑**: 连续触发时注意控制频率，避免过度占用系统资源
3. **错误处理**: 系统会自动处理大部分错误，并在日志中记录详细信息
4. **数据安全**: 所有匹配结果都会自动保存，建议定期备份数据库

## 故障排除

### 常见问题

1. **键盘监听不工作**
   - 检查是否安装了 `pynput`
   - 确认系统权限设置
   - 查看日志中的错误信息

2. **匹配结果不准确**
   - 调整匹配阈值设置
   - 检查模板图片质量
   - 确认截图区域设置正确

3. **数据库记录失败**
   - 检查数据库文件权限
   - 确认会话ID有效
   - 查看详细错误日志

### 日志分析

系统会记录详细的运行日志，包括：
- 功能状态变化
- 匹配过程详情
- 错误信息和堆栈跟踪
- 数据库操作结果

通过分析日志可以快速定位和解决问题。
