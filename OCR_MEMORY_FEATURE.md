# OCR记忆功能说明

## 功能概述

OCR记忆功能是TFT Card Statistics项目的一个改进特性，它解决了OCR识别失败时程序中断的问题。当OCR无法识别数字时，系统会自动延用上次成功识别的结果，确保程序的连续性和稳定性。

## 主要特性

### 1. 自动记忆上次识别结果
- OCR成功识别数字后，自动保存到内存中
- 下次识别失败时，自动使用上次的结果
- 无需手动配置，完全自动化

### 2. 智能回退机制
- **有历史记录时**：延用上次识别的数字
- **无历史记录时**：使用默认值2
- 确保程序始终返回有效的数字结果

### 3. 日志记录
- 详细记录OCR识别过程
- 清晰标识何时使用回退值
- 便于调试和监控

## 使用方法

### 基本使用
```python
from src.ocr_module import NumberOCR

# 创建OCR实例
ocr = NumberOCR()

# 识别数字（现在总是返回有效结果）
number = ocr.recognize_number(image)
print(f"识别结果: {number}")
```

### 在主程序中的使用
主程序已经集成了OCR记忆功能，无需额外配置：

```bash
# 使用固定区域模式
python run.py --use-fixed-regions --threshold 0.8

# 持续监控模式
python run.py --continuous --threshold 0.85
```

## 工作流程

```
1. OCR识别成功 → 更新记忆的数字 → 返回识别结果
2. OCR识别失败 → 检查是否有历史记录
   ├─ 有历史记录 → 延用上次结果
   └─ 无历史记录 → 使用默认值2
```

## 配置选项

### 默认值设置
- **默认回退值**: 2
- **数字范围**: 0-10
- **记忆持久性**: 程序运行期间保持

### 自定义配置
如需修改默认值，可以编辑 `src/ocr_module.py` 中的 `_get_fallback_number` 方法：

```python
def _get_fallback_number(self) -> int:
    if self.last_recognized_number is not None:
        return self.last_recognized_number
    else:
        return 2  # 修改这里的默认值
```

## 测试和验证

### 运行测试脚本
```bash
# 测试OCR记忆功能
python test_ocr_memory.py

# 演示OCR记忆功能
python demo_ocr_memory.py
```

### 测试场景
1. **正常识别**: 验证OCR正常工作
2. **识别失败**: 验证回退机制
3. **新实例**: 验证默认值设置
4. **连续失败**: 验证记忆持久性

## 日志输出示例

### 成功识别
```
INFO:src.ocr_module:OCR识别成功: 5
```

### 识别失败，使用回退值
```
WARNING:src.ocr_module:OCR识别失败，结果: ''
INFO:src.ocr_module:OCR识别失败，延用上次结果: 5
```

### 无历史记录，使用默认值
```
WARNING:src.ocr_module:OCR识别失败，结果: ''
INFO:src.ocr_module:OCR识别失败且无上次结果，使用默认值: 2
```

## 优势

### 1. 提高稳定性
- 避免因OCR失败导致的程序中断
- 确保数据收集的连续性

### 2. 改善用户体验
- 减少手动干预的需求
- 提供更可靠的识别结果

### 3. 便于调试
- 清晰的日志记录
- 可追踪的回退逻辑

## 注意事项

### 1. 记忆范围
- 记忆仅在程序运行期间有效
- 程序重启后记忆会重置

### 2. 默认值选择
- 默认值2是基于TFT游戏常见情况设置的
- 可根据实际需求调整

### 3. 性能影响
- 记忆功能对性能影响极小
- 仅增加少量内存占用

## 故障排除

### 常见问题

#### 1. OCR总是返回默认值
- 检查Tesseract是否正确安装
- 验证图像质量和预处理效果
- 查看日志确认识别过程

#### 2. 回退值不正确
- 确认上次识别是否成功
- 检查记忆变量状态
- 验证回退逻辑

#### 3. 性能问题
- 检查图像大小和预处理步骤
- 优化OCR配置参数
- 监控内存使用情况

### 调试建议
1. 启用详细日志记录
2. 使用测试脚本验证功能
3. 检查图像预处理效果
4. 监控OCR识别成功率

## 更新历史

- **v1.0**: 初始版本，基本记忆功能
- **v1.1**: 改进日志记录和错误处理
- **v1.2**: 优化回退逻辑和性能

## 技术支持

如果遇到问题或需要帮助，请：
1. 查看日志输出
2. 运行测试脚本
3. 检查配置设置
4. 联系开发团队

---

*最后更新: 2024年*
